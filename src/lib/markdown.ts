import { marked } from "marked";
import type { Tokens } from "marked";

export interface ParsedMarkdown {
	html: string;
	title: string;
	headings: { text: string; id: string; level: number }[];
}

const DEFAULT_H2_ICON = `
<svg
	xmlns="http://www.w3.org/2000/svg"
	width="24" height="24"
	viewBox="0 0 24 24"
>
	<path fill="currentColor" d="M10.306 12.482c-.15-.11-.27-.1-.791.15c-.52.25-1.241.67-2.693 1.431a.35.35 0 0 0-.16.48a.34.34 0 0 0 .47.16c1.002-.46 1.772-.81 2.253-1c-.18.59-.48 1.441-.821 2.272q-.405 1.031-.94 2.002a1.8 1.8 0 0 1-.411.56h-.13l-.38-.06c-.361-.09-.721-.22-.922-.28l-4.153-1.301l1.33-.571a.32.32 0 0 0 .191-.41a.31.31 0 0 0-.4-.18c-.64.22-2.522.92-2.543.93a.32.32 0 0 0-.19.4q.28.862.44 1.752c.18.911.311 1.822.461 2.733q.054.661.18 1.31c.06.3.223.57.46.762c.237.147.513.217.791.2q.652-.08 1.272-.3c.68-.2 1.36-.42 2.001-.651c.64-.23 1.332-.48 2.002-.73a75 75 0 0 0 2.502-1.002c.5-.22 1.001-.46 1.632-.76a4.3 4.3 0 0 0 1.321-.921c.219-.248.334-.57.32-.901a12 12 0 0 0-1.23-3.193a11.7 11.7 0 0 0-1.863-2.882m1.721 6.465a4 4 0 0 1-.76.41L7.152 21.01l-3.913 1.45c-.2.07-.48.2-.75.27s-.43.281-.53-.45c-.081-.36-.121-.74-.151-.91c-.22-.901-.4-1.812-.64-2.713q-.136-.57-.33-1.12c.57.23 1.57.64 2.571 1c.771.29 1.522.57 2.062.75q.707.272 1.451.401c.343.07.698.013 1.001-.16a6.2 6.2 0 0 0 1.462-2.522q.612-1.592 1-3.253c.3.51.661 1.25 1.002 2.002a11 11 0 0 1 1 2.872c-.04.13-.21.22-.36.32"/><path fill="currentColor" d="M15.49 1.892c.22.36.295.789.21 1.201c0 .12-.44.69-.54.951a.62.62 0 0 0 0 .53c.083.152.203.28.35.37c.18.121.42.181.57.281c.298.2.55.458.741.76a.82.82 0 0 1 .13.802q-.096.182-.25.32a2 2 0 0 1-.37.24a2.4 2.4 0 0 0-.43.19a.45.45 0 0 0-.22.3a.75.75 0 0 0 .19.561c.21.26.64.59.72.8a.88.88 0 0 1-.11.861c-.403.43-.89.77-1.431 1.001a.31.31 0 0 0-.14.42a.32.32 0 0 0 .43.14a5 5 0 0 0 1.691-1.1a1.52 1.52 0 0 0 .25-1.522a3.3 3.3 0 0 0-.49-1q.237-.114.44-.28c.19-.147.346-.331.461-.541a1.5 1.5 0 0 0 0-1.371a3.4 3.4 0 0 0-1.13-1.392l-.291-.16c.162-.268.287-.558.37-.86a2.93 2.93 0 0 0-.4-2.403a1.84 1.84 0 0 0-1.632-.8a2.19 2.19 0 0 0-1.861 1.16c-.333.85-.558 1.738-.67 2.643c-.19.866-.483 1.706-.872 2.502a6.9 6.9 0 0 1-1.511 2.062c-.18.16-.59.56-1.001.92a5 5 0 0 1-.61.451a8.4 8.4 0 0 0-1.442-1.2c.13-.944.13-1.9 0-2.843a4.8 4.8 0 0 0-.81-2.002c-.31-.42-1.001-.95-1.402-1.541a.87.87 0 0 1-.24-.761a.31.31 0 0 1 .24-.18c.21-.068.43-.098.65-.09c.48-.003.956.1 1.392.3c.13.08.15.23.2.34q.082.213.21.4q.076.106.18.18a.8.8 0 0 0 .411.16q.399.005.79-.06c.213.003.423.044.621.12c.192.082.366.201.51.351q.122.148.18.33q.067.19.06.39c0 .07-.11.341-.12.511a.53.53 0 0 0 .1.41a.35.35 0 0 0 .501 0s.18-.08.28-.9a1.9 1.9 0 0 0-.06-.67a1.7 1.7 0 0 0-.37-.541a2.15 2.15 0 0 0-.75-.64a3.75 3.75 0 0 0-1.592-.321a2.4 2.4 0 0 0-.19-.48a1.15 1.15 0 0 0-.4-.45A4.4 4.4 0 0 0 4.66.18a1.72 1.72 0 0 0-1.7 1.09a1.77 1.77 0 0 0 .21 1.482a15.6 15.6 0 0 0 1.792 1.832c.37.44.64.955.79 1.51c.177.775.248 1.57.21 2.363a2 2 0 0 0-.31-.07a3.6 3.6 0 0 0-1.691.21A2.69 2.69 0 0 0 2.118 11a3.1 3.1 0 0 0 1.251 2.443a2 2 0 0 0 0 .22q.02.324.1.64l.14.57c.063.331.24.63.501.842c.22.11.53.15.86-.28l.21-.321l.782-1.111a.36.36 0 0 0-.56-.44l-.842 1.19l-.08.12a.8.8 0 0 1-.08-.16l-.12-.55c0-.14 0-.29-.06-.44a1.1 1.1 0 0 1 0-.36a.42.42 0 0 0-.15-.36a2.33 2.33 0 0 1-1.001-1.883A1.71 1.71 0 0 1 4.27 9.59a2.55 2.55 0 0 1 1.231-.13c.388.085.739.292 1.001.59c.14.15.49.621.76.861a1 1 0 0 0 .551.29a2 2 0 0 0 1.151-.46a19 19 0 0 0 1.562-1.291a8 8 0 0 0 1.751-2.452c.446-.877.782-1.804 1.001-2.763c.08-.803.258-1.593.53-2.352a1.09 1.09 0 0 1 .931-.59c.32 0 .581.28.751.6m8.488 13.301a12.5 12.5 0 0 0-.791-3.003a2.4 2.4 0 0 0-.51-.84a1.4 1.4 0 0 0-.781-.32c-.484.002-.965.07-1.432.2q-1.04.293-2.111.44a2.56 2.56 0 0 1-1.272-.22a.36.36 0 0 0-.3.65a3.4 3.4 0 0 0 1.592.37q1.137-.081 2.252-.32q.431-.092.87-.13c.581 0 .54.21.611.39q.326.935.53 1.902c.49 2.002 0 2.162-.88 2.092c-1.151-.09-2.372-.74-3.443-.61a1.06 1.06 0 0 0-.56.24q-.273.314-.501.66q-.36.397-.771.741q-.399.346-.86.6l-1.112.491a.31.31 0 0 0-.19.4a.31.31 0 0 0 .39.2l1.221-.45a6 6 0 0 0 1.001-.61a7.5 7.5 0 0 0 .911-.761q.206-.218.38-.46a.24.24 0 0 1 .13-.09c.511.02 1.014.135 1.482.34q.86.338 1.771.49a2.87 2.87 0 0 0 1.792-.37a1.18 1.18 0 0 0 .51-.76a3.9 3.9 0 0 0 .07-1.262"/>
</svg>
`;

const VIDEO_H2_ICON = `
<svg
	xmlns="http://www.w3.org/2000/svg"
	width="24" height="24"
	viewBox="0 0 24 24"
>
	<g
		fill="currentColor"
		fill-rule="evenodd"
		clip-rule="evenodd"
	>
		<path d="M18.98 5.667h-4.167c-1.933 0-3.866.09-5.789.2c-2.424.14-4.858.35-7.291.521c-.581.16-.501.691 0 .771h7.351c1.923 0 3.836-.17 5.76-.23c1.381-.07 2.753-.14 4.136-.18h3.054c.571-.11.521-.832-.15-.832c-.981-.18-1.903-.23-2.904-.25"/><path d="M23.987 8.371a14.4 14.4 0 0 0-.25-3.345a4.5 4.5 0 0 0-1.142-2.153a3.56 3.56 0 0 0-2.003-1.002a13.4 13.4 0 0 0-2.894 0L.95 2.873a.32.32 0 0 0-.31.3a.33.33 0 0 0-.29.32c0 1.843-.28 5.86-.351 8.714v3.776c.05.841 0 2.003.1 2.935c.068.488.224.96.46 1.392a3.33 3.33 0 0 0 1.834 1.352c1.489.394 3.027.573 4.567.53a80 80 0 0 0 8.162-.26a98 98 0 0 0 8.083-1.001a.38.38 0 0 0-.11-.752a102 102 0 0 1-8.013.722a81 81 0 0 1-8.012 0a19.5 19.5 0 0 1-3.616-.33a2.65 2.65 0 0 1-1.712-.952a3.2 3.2 0 0 1-.36-1.312c-.091-.842-.05-1.743-.111-2.454a50 50 0 0 1-.2-3.686c-.05-2.514 0-6.61 0-8.663c1.923 0 7.431-.08 11.758-.18c2.223 0 4.126-.12 5.008-.15a12.6 12.6 0 0 1 2.614 0c.489.066.946.279 1.312.61c.411.428.696.962.821 1.542c.11.401.31 2.915.32 3.005l.08 4.557v3.906c0 .882 0 1.753.09 2.624a.38.38 0 0 0 .254.34a.4.4 0 0 0 .148.02a.373.373 0 0 0 .36-.39v-2.584c0-1.302.08-2.604.13-3.906z"/><path d="M12.039 15.042c.76-.411 1.462-1.002 2.113-1.463c.23-.15.6-.33.871-.53c.185-.122.345-.279.471-.461a.65.65 0 0 0 0-.751a7.3 7.3 0 0 0-.951-.892q-.757-.549-1.573-1.001q-.818-.464-1.692-.812a.37.37 0 0 0-.481.16a.44.44 0 0 0-.22-.07a.34.34 0 0 0-.321.361v4.828c0 .13-.12.37-.12.49a.64.64 0 0 0 .18.441a.65.65 0 0 0 .641.19a4 4 0 0 0 1.082-.49m-1.072-5.199q.793.379 1.512.882q.724.5 1.383 1.082l.41.31l-.781.44c-.56.361-1.162.842-1.793 1.243l-.4.25l-.06-.871l-.271-3.346zm-7.381 8.303a.34.34 0 0 0-.28.38a.33.33 0 0 0 .38.281c.57-.05 1.141-.08 1.702-.09H6.46c.26 1.142.32 1.352.651 1.332c.33-.02.35-.27.47-1.322h1.874c1.532-.08 3.065-.13 4.587-.24c2.293-.15 4.567-.39 6.87-.551a.38.38 0 0 0 .371-.39a.39.39 0 0 0-.39-.371c-2.324 0-4.618 0-6.921.07c-1.533.06-3.005.19-4.587.29l-1.803.15a2 2 0 0 0 0-.22c-.36-1.422-.621-1.422-.751-1.422s-.381 0-.491 1.522a2 2 0 0 0 0 .23l-1.002.09c-.58.081-1.162.161-1.752.261"/>
	</g>
</svg>
`;

export async function parseMarkdown(raw: string): Promise<ParsedMarkdown> {
	const headings: ParsedMarkdown["headings"] = [];
	let title = "";

	marked.use({
		renderer: {
			heading(token: Tokens.Heading) {
				const text = token.text;
				const level = token.depth;

				const id = text.toLowerCase().replace(/[^\w]+/g, "-");

				if (level === 1 && !title) {
					title = text;
					return "";
				}

				if (level >= 2) {
					headings.push({ text, id, level });
				}

				const isVideo =
					level === 2 &&
					(text.toLowerCase() === "v√≠deo");

				const icon =
					level === 2
						? isVideo
							? VIDEO_H2_ICON
							: DEFAULT_H2_ICON
						: "";

				return `
					<h${level} id="${id}" class="${isVideo ? "saintDetail_videoTitle" : ""}">
						<span class="md_h2_icon">${icon}</span>
						<span class="md_h2_text">${text}</span>
					</h${level}>
				`;
			},
		},
	});

	const html = await marked.parse(raw);

	return { html, title, headings };
}
